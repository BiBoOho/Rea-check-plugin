jQuery.noConflict();
(function(a,n,C){const q={opacity:!1,doRender:!1,buildCallback:function(c){c.addClass("kintone-ui");const d=this.color,e=this;c.prepend('<div class="cp-panel"><div><label>R</label> <input type="number" max="255" min="0" class="cp-r" /></div><div><label>G</label> <input type="number" max="255" min="0" class="cp-g" /></div><div><label>B</label> <input type="number" max="255" min="0" class="cp-b" /></div><hr><div><label>H</label> <input type="number" max="360" min="0" class="cp-h" /></div><div><label>S</label> <input type="number" max="100" min="0" class="cp-s" /></div><div><label>V</label> <input type="number" max="100" min="0" class="cp-v" /></div></div>').on("change","input",
function(b){b=this.value;const f=this.className.split("-")[1],p={};p[f]=b;d.setColor("HEX"===f?b:p,"HEX"===f?"HEX":/(?:r|g|b)/.test(f)?"rgb":"hsv");e.render()});const h=c.append('<div class="cp-disp"><button type="button" id="cp-submit">OK</button><button type="button" id="cp-cancel">Cancel</button></div>');h.on("click","#cp-submit",b=>{b="#"+e.color.colors.HEX;c.css("border-bottom-color",b);c.attr("value",b);const f=e.$trigger.parent("div").find('input[type="text"]');f.val(b);f.css("color",b);e.$trigger.css("border-bottom-color",
b);e.toggle(!1)});h.on("click","#cp-cancel",b=>{e.toggle(!1)})},renderCallback:function(c,d){d=this.color.colors.RND;const e={r:d.rgb.r,g:d.rgb.g,b:d.rgb.b,h:d.hsv.h,s:d.hsv.s,v:d.hsv.v,HEX:"#"+this.color.colors.HEX};a("input",".cp-panel").each(function(){this.value=e[this.className.substr(3)]});this.$trigger=c},positionCallback:function(c){this.color.setColor(c.attr("value"))}},A=[{text:"Date and time",classCB:"datetimeCB",name:"datetime",code:"DATE_TIME"},{text:"Username",classCB:"usernameCB",name:"username",
code:"USER_SELECT"},{text:"Revision",classCB:"revisionCB",name:"revision",code:"REVISION"}],r=a("#font-color-picker-unread"),t=a("#bg-color-picker-unread"),u=a("#font-color-picker-read"),v=a("#bg-color-picker-read"),D=a(".apiToken #create_api"),E=a(".save"),F=a(".cancel"),k=a("#db_id"),w=a("#api_token"),l=a("#indication_list"),z=a(".Qtynumber"),B=a(".recordUpdateCB"),g=kintone.plugin.app.getConfig(C),G=a(".datetimeCB"),H=a(".usernameCB"),I=a(".revisionCB"),x=a("#dropAndDrag1");let m=[];const y=(c,
d,e)=>`<div class='drop' id='${c}' name='${e}' draggable='true' style='display:flex'>
              <i class='gg-menu'></i>
              <h6>${d}</h6>
            </div>`;g&&(k.val(g.db_id),w.val(g.db_api_token),l.val());const K=async()=>{try{let c=a("<option>");c.attr("value","header");c.text("header");l.append(c);const d={app:kintone.app.getId()};(await kintone.api("/k/v1/preview/app/form/layout","GET",d)).layout.forEach(e=>{e.fields.forEach(h=>{if("SPACER"===h.type){let b=a("<option>");b.attr("value",h.elementId);b.text(h.elementId);l.append(b)}})});J()}catch(c){return n.fire("Error",c.message||c,"error")}},J=async()=>{if(g){k.val(g.db_id||"");
w.val(g.db_api_token||"");l.val(g.space_display||"");z.val(g.readed_qty||"Read: {%Num%}");m=g.display_items?JSON.parse(g.display_items):[];m.forEach(e=>{let h=A.filter(b=>b.code===e.code)[0];a(`.${h.classCB}`).prop("checked",!0);x.append(y(h.code,h.text,h.name))});B.prop("checked","yes"===(g.reset_value||"no")?!0:!1);var c=g.unread?{text:JSON.parse(g.unread).text,bg:JSON.parse(g.unread).bg}:{text:"#000000",bg:"#"},d=g.readed?{text:JSON.parse(g.readed).text,bg:JSON.parse(g.readed).bg}:{text:"#000000",
bg:"#"};r.val(c.text);t.val(c.bg);u.val(d.text);v.val(d.bg);r.css("color",c.text);t.css("color",c.bg);u.css("color",d.text);v.css("color",d.bg)}},L=async()=>{if(!k.val())throw Error("Please input db app id");if(!z.val())throw Error("Please input read already statement text");if(isNaN(parseInt(k.val())))throw Error("App id shoud be in number");let c={app:k.val()};try{let d=await window.RsComAPI.kintoneApi(kintone.api.url("/k/v1/app/form/fields",!0),"GET",c,w.val());if(!A.map(f=>f.code).every(f=>Object.prototype.hasOwnProperty.call(d.properties,
f)))throw Error("App ID and Api Token that defined is not for ReadDB app");m=[];a(".drop").each(function(){m.push({label:a(this).attr("name"),code:a(this).attr("id")})});let e=B.prop("checked"),h={text:r.val(),bg:t.val()},b={text:u.val(),bg:v.val()};return{db_id:k.val(),db_api_token:w.val(),space_display:l.val(),readed_qty:z.val(),display_items:JSON.stringify(m),reset_value:e?"yes":"no",unread:JSON.stringify(h),readed:JSON.stringify(b)}}catch(d){throw Error(d.message||d);}};a(document).ready(function(){K();
D.on("click",function(){if(!k.val())return n.fire("No DB App ID","Please enter DB app ID!","error");let b=window.location.protocol,f=window.location.hostname,p="?app="+encodeURIComponent(k.val());window.open(b+"//"+f+"/k/admin/app/apitoken"+p,"_BLANK")});a("#db_id").on("input",function(){a(this).val(a(this).val().replace(/[^0-9]/g,""))});a(document).on("dragstart","#dropAndDrag1 > div",function(b){a(this).addClass("dragging");b.originalEvent.dataTransfer.setData("text/plain","")});a(document).on("dragover",
"#dropAndDrag1 > div",function(b){b.preventDefault();a(this).addClass("dragover")});a(document).on("dragleave","#dropAndDrag1 > div",function(){a(this).removeClass("dragover")});a(document).on("drop","#dropAndDrag1 > div",function(b){b.preventDefault();a(this).removeClass("dragover");b=a(".dragging");const f=a(this);b.index()<f.index()?b.insertAfter(f):b.insertBefore(f)});a(document).on("dragend","#dropAndDrag1 > div",function(){a(this).removeClass("dragging")});a(document).on("click",".datetimeCB",
function(){G.prop("checked")?x.append(y("DATE_TIME","Date and time","datetime")):a("#DATE_TIME").remove()});a(document).on("click",".usernameCB",function(){H.prop("checked")?x.append(y("USER_SELECT","Username","username")):a("#USER_SELECT").remove()});a(document).on("click",".revisionCB",function(){I.prop("checked")?x.append(y("REVISION","Revision","revision")):a("#REVISION").remove()});const c=a("#font-color-picker-unread-icon").colorPicker(q),d=a("#bg-color-picker-unread-icon").colorPicker(q),e=
a("#font-color-picker-read-icon").colorPicker(q),h=a("#bg-color-picker-read-icon").colorPicker(q);a(document).keyup(b=>{if(9===b.keyCode||13===b.keyCode||27===b.keyCode)c.colorPicker.toggle(!1),d.colorPicker.toggle(!1),e.colorPicker.toggle(!1),h.colorPicker.toggle(!1)});r.change(function(){a(this).css("color",a(this).val())});t.change(function(){a(this).css("color",a(this).val())});u.change(function(){a(this).css("color",a(this).val())});v.change(function(){a(this).css("color",a(this).val())});E.on("click",
async function(){await L().then(b=>{kintone.plugin.app.setConfig(b,function(){n.fire("Complete","\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f\u3001\u30a2\u30d7\u30ea\u3092\u66f4\u65b0\u3057\u3066\u304f\u3060\u3055\u3044\uff01","success").then(function(){window.location.href="../../flow?app="+kintone.app.getId()+"#section=settings"})})}).catch(b=>{n.fire("Error",b.message||b,"error")})});F.on("click",function(){window.location.href="../../"+kintone.app.getId()+
"/plugin/"})})})(jQuery,Sweetalert2_10.noConflict(!0),kintone.$PLUGIN_ID);
