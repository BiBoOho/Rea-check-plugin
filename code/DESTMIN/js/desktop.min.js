jQuery.noConflict();
(function(b,E,p){p=kintone.plugin.app.getConfig(p);if(0!==!Object.keys(p).length){var F=p.db_id||"",J=p.db_api_token||"",K=p.display_items?JSON.parse(p.display_items):[],N=p.readed_qty||"",G=p.space_display||"",H=p.reset_value||"no",y=p.unread?JSON.parse(p.unread):{},z=p.readed?JSON.parse(p.readed):{},O=[{id:"datetimeDiv",text:"Date and time",name:"datetime"},{id:"usernameDiv",text:"Username",name:"username"},{id:"revisionDiv",text:"Revision",name:"revision"}];kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],
async function(g){try{let x=kintone.getLoginUser().code,q=g.records;if(0>=q.length)return g;var h=`APP_ID = ${kintone.app.getId()} and USER_SELECT in ("${x}") and (`;for(g=0;g<q.length;g++){var m=q[g];h+="RECORD_ID = "+m.$id.value;"yes"==H&&(h+=" and REVISION="+m.$revision.value);h=g!=q.length-1?h+" or ":h+")"}let t=await window.RsComAPI.getRecords({app:F,query:h}),u=t.length;for(h=0;h<q.length;h++){let w=q[h],r=b.map(w,function(k,c){return[c]}),f,a;for(a=u-1;0<=a&&t[a].RECORD_ID.value!==w.$id.value;a--);
if(0<=a)for(m=0;m<r.length;m++){let k=r[m];f=kintone.app.getFieldElements(k)||kintone.mobile.app.getFieldElements(k);null!==f&&(("#"!==z.bg||z.bg)&&b(f[h]).parent().css({"background-color":z.bg}),("#"!==z.text||z.text)&&b(f[h]).parent().css({color:z.text}))}else for(m=0;m<r.length;m++)f=kintone.app.getFieldElements(r[m]),null!==f&&(("#"!==y.bg||y.bg)&&b(f[h]).parent().css({"background-color":y.bg}),("#"!==y.text||y.text)&&b(f[h]).parent().css({color:y.text}))}}catch(x){return E.fire("Error",x.message||
x,"error")}});var P=async(g,h,m,x,q,t)=>{try{const u=kintone.getLoginUser();let w=await window.RsComAPI.getRecords({app:g,query:h,token:J});if(!w.some(f=>f.USER_SELECT.value.some(a=>a.code===u.code)&&f.REVISION.value===t)){let f={app:g,record:{APP_ID:{value:x},RECORD_ID:{value:q},REVISION:{value:t},USER_SELECT:{value:[{code:u.code,name:u.name}]}}};await window.RsComAPI.kintoneApi(kintone.api.url("/k/v1/record",!0),"POST",f,m);w.push({REVISION:{value:t},USER_SELECT:{value:[{code:u.code,name:u.name}]},
DATE_TIME:{value:Date.now()}})}if("yes"===H)return w;w.sort((f,a)=>parseInt(a.REVISION.value)-parseInt(f.REVISION.value));let r=new Map;for(let f of w){let a=f.USER_SELECT.value[0].code;r.has(a)||r.set(a,f)}return Array.from(r.values())}catch(u){return E.fire("Error",u.message||u,"error")}};kintone.events.on(["app.record.detail.show","mobile.app.record.detail.show"],async function(g){function h(a,k){"REVISION"===k?"asc"===a?b(".revisionDiv.gg-arrow-up").css({display:"inline"}):"desc"===a?b(".revisionDiv.gg-arrow-down").css({display:"inline"}):
(b(".revisionDiv.gg-arrow-up").css({display:"none"}),b(".revisionDiv.gg-arrow-down").css({display:"none"})):"USER_SELECT"===k?"asc"===a?b(".usernameDiv.gg-arrow-up").css({display:"inline"}):"desc"===a?b(".usernameDiv.gg-arrow-down").css({display:"inline"}):(b(".usernameDiv.gg-arrow-up").css({display:"none"}),b(".usernameDiv.gg-arrow-down").css({display:"none"})):"DATE_TIME"===k&&("asc"===a?b(".datetimeDiv.gg-arrow-up").css({display:"inline"}):"desc"===a?b(".datetimeDiv.gg-arrow-down").css({display:"inline"}):
(b(".datetimeDiv.gg-arrow-up").css({display:"none"}),b(".datetimeDiv.gg-arrow-down").css({display:"none"})))}function m(a,k,c,l){var e=a.map(d=>{var n={...d.DATE_TIME},v=new Date(d.DATE_TIME.value);const L=v.getFullYear(),I=String(v.getMonth()+1).padStart(2,"0"),C=String(v.getDate()).padStart(2,"0"),D=String(v.getHours()).padStart(2,"0"),A=String(v.getMinutes()).padStart(2,"0");v=String(v.getSeconds()).padStart(2,"0");return{...d,DATE_TIME:{...n,value:`${L}-${I}-${C} ${D}:${A}:${v}`}}});a=[];if(c&&
l)switch(c){case "asc":switch(l){case "USER_SELECT":a=[...e].sort((d,n)=>d.USER_SELECT.value[0].name.localeCompare(n.USER_SELECT.value[0].name));break;case "REVISION":a=[...e].sort((d,n)=>parseInt(d.REVISION.value)-parseInt(n.REVISION.value));break;case "DATE_TIME":a=[...e].sort((d,n)=>new Date(d.DATE_TIME.value)-new Date(n.DATE_TIME.value))}break;case "desc":switch(l){case "USER_SELECT":a=[...e].sort((d,n)=>n.USER_SELECT.value[0].name.localeCompare(d.USER_SELECT.value[0].name));break;case "REVISION":a=
[...e].sort((d,n)=>parseInt(n.REVISION.value)-parseInt(d.REVISION.value));break;case "DATE_TIME":a=[...e].sort((d,n)=>new Date(n.DATE_TIME.value)-new Date(d.DATE_TIME.value))}}else a=e;c=100*(k-1);l=a.slice(c,c+100);c="";0<b("#divEl").length?c=b("#divEl").empty():(c=b("<div>").css({height:"400px",display:"inline-flex","flex-direction":"column","justify-content":"space-between"}),c.attr("id","divEl"));a=b("<table>");e=b("<thead>");let B=b("<tr>");b.each(K,function(d,n){d=O.filter(v=>v.name===n.label)[0];
d=b("<th>").text(d.text).css({cursor:"pointer"}).append(b("<span>").addClass(`${d.id} gg-arrow-down`).css({display:"none"}),b("<span>").addClass(`${d.id} gg-arrow-up`).css({display:"none"}));B.append(d)});e.append(B);a.append(e);let M=b("<tbody>").attr("id","tbody");b.each(l,function(d,n){let v=b("<tr>");b.each(K,function(L,I){b.each(n,function(C,D){if(C==I.code){let A=b("<td>");"USER_SELECT"===C?A.text(D.value[0].name):A.text(D.value);v.append(A)}})});M.append(v)});a.append(M);l=b("<div>").addClass("tableFixHead").append(a);
c.append(l);l=b("<div>").css({display:"flex","justify-content":"center","margin-top":"1rem","margin-right":"30px"});a=b("<span>").text("<Previous");a.css({cursor:"pointer","margin-right":"10px"}).attr("id","prevIcon");e=b("<span>").text("Next>");e.css({cursor:"pointer","margin-left":"10px"}).attr("id","nextIcon");let Q=b("<span>").text(k);l.append(a);l.append(Q);l.append(e);c.append(l);1===f?(e.css("color","transparent"),a.css("color","transparent")):1===k?a.css("color","transparent"):k===f?e.css("color",
"transparent"):(a.show(),e.show());b("#container").append(c);return c}if(!F)return g;let x;x="header"===G?kintone.app.record.getHeaderMenuSpaceElement()||kintone.mobile.app.getHeaderSpaceElement():kintone.app.record.getSpaceElement(G)||kintone.mobile.app.record.getSpaceElement(G);var q=g.appId,t=g.recordId;const u=g.record.$revision.value;let w=`APP_ID = "${q}" and RECORD_ID = "${t}"`;"yes"===H&&(w+=` and REVISION = "${u}"`);let r=await P(F,w,J,q,t,u);if(!x)return g;q=r.length;t=N.replace(/{%Num%}/g,
`<a class='numClick' style='text-decoration:none;'>${q}</a>`);t=b("<h1>").html(`${t}`).css({"font-size":"25px",margin:"0px"});b(x).append(t);if("mobile.app.record.detail.show"===g.type)return g;let f=Math.ceil(q/100);b(document).on("click",".numClick",function(){let a=1,k="",c="",l={};E.fire({width:"66%",html:m(r,1),scrollbarPadding:!1,showCancelButton:!0,cancelButtonColor:"#48A1E0",cancelButtonText:"Close",showConfirmButton:!1});b(document).off("click.numClick").on("click.numClick",e=>{if(b(e.target).is("th")){"Revision"===
e.target.textContent?c="REVISION":"Username"===e.target.textContent?c="USER_SELECT":"Date and time"===e.target.textContent&&(c="DATE_TIME");l[c]=l[c]?"asc"===l[c]?"desc":"":"asc";for(const B in l)B!==c&&(l[B]="");k=l[c];a=1;m(r,1,k,c);h(k,c)}else if("prevIcon"===e.target.id){if(0>=a-1)return g;a--;m(r,a,k,c);h(k,c)}else if("nextIcon"===e.target.id){if(a+1>f)return g;a++;m(r,a,k,c);h(k,c)}})});return g})}})(jQuery,Sweetalert2_10.noConflict(!0),kintone.$PLUGIN_ID);
